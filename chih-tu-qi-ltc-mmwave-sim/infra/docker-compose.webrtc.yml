services:
  isaac-webrtc:
    image: nvcr.io/nvidia/isaac-sim:4.2.0
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - ACCEPT_EULA=Y
      - PRIVACY_CONSENT=Y
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all,graphics,display
      - OMNI_KIT_ALLOW_ROOT=1
      # WebRTC streaming settings
      - STREAMING_CLIENT=webrtc
      - LIVESTREAM_WEBSOCKET_PORT=49100
      - PROJECT_ROOT=/workspace/chih-tu-qi-ltc-mmwave-sim
    volumes:
      - ..:/workspace/chih-tu-qi-ltc-mmwave-sim
      - isaac-cache:/root/.cache/ov
      - isaac-data:/root/.local/share/ov/data
      - isaac-logs:/root/.nvidia-omniverse/logs
    working_dir: /workspace/chih-tu-qi-ltc-mmwave-sim
    # Use host network for WebRTC (required for UDP)
    network_mode: host
    ipc: host
    security_opt:
      - seccomp:unconfined
    ulimits:
      memlock: -1
      stack: 67108864
    stdin_open: true
    tty: true
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo "=============================================="
        echo " Isaac Sim WebRTC Streaming Server"
        echo "=============================================="

        # Check GPU
        nvidia-smi || { echo "GPU not available"; exit 1; }
        echo ""

        # Start Isaac Sim with WebRTC streaming enabled
        echo "Starting Isaac Sim with WebRTC streaming..."
        echo "WebRTC client will be available at: http://<host-ip>:8211/streaming/webrtc-demo"
        echo ""

        # Use the WebRTC launch script
        /isaac-sim/runheadless.webrtc.sh \
          --/app/window/width=1920 \
          --/app/window/height=1080 \
          --/renderer/activeGpu=0 \
          --/app/renderer/resolution/width=1920 \
          --/app/renderer/resolution/height=1080 \
          --/rtx/post/aa/op=3 \
          --/app/livestream/logLevel=info \
          --allow-root

volumes:
  isaac-cache:
  isaac-data:
  isaac-logs:
